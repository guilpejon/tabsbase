<% has_chords = tab_has_chords?(@tab.content) %>
<% unique_chords = has_chords ? extract_unique_chords(@tab.content) : [] %>
<% is_chord_tab = @tab.tab_type == "chords" %>
<div class="w-full pb-16" data-controller="singer-mode<%= ' chord-diagram' if has_chords %><%= ' transpose' if is_chord_tab && has_chords %>" data-chord-diagram-chords-value="<%= unique_chords.to_json %>" data-singer-mode-chord-tab-value="<%= is_chord_tab %>" data-transpose-original-chords-value="<%= unique_chords.to_json %>" data-action="transpose:transposed->chord-diagram#handleTranspose">
  <div class="mb-6 px-4 sm:px-0">
    <%= link_to "â† Back to search", root_path(q: params[:q]), class: "text-sm text-slate-600 hover:text-slate-900" %>

    <div class="mt-3 flex items-start justify-between gap-4">
      <div class="min-w-0">
        <h1 class="text-2xl font-semibold tracking-tight"><%= @tab.display_name %></h1>
        <div class="mt-2 flex flex-wrap items-center gap-x-1 gap-y-1 text-sm text-slate-600">
          <span><%= @tab.tuning.full_name %></span>
          <% if @tab.difficulty.present? %>
            <span>â€¢ <%= @tab.difficulty %></span>
          <% end %>
          <% if @tab.capo.present? %>
            <span>â€¢ Capo <%= @tab.capo %></span>
          <% end %>
          <span>â€¢ <%= number_with_delimiter(@tab.views_count) %> views</span>
          <% if @tab.rating.present? %>
            <span>â€¢ <%= @tab.rating.to_f.round(2) %>/5</span>
          <% end %>
          <% if @tab.source_url.present? %>
            <span>â€¢ <%= link_to "Source", @tab.source_url, target: "_blank", rel: "noopener", class: "underline decoration-slate-300 hover:decoration-slate-600" %></span>
          <% end %>
          <% if @tab.youtube_url.present? %>
            <span>â€¢ <%= link_to "ðŸŽ¬ Video", @tab.youtube_url, target: "_blank", rel: "noopener", class: "underline decoration-slate-300 hover:decoration-slate-600" %></span>
          <% end %>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <% if @tab.tab_type == "chords" && has_chords %>
        <%# Transpose Controls - only for chord tabs with chords %>
        <div class="flex items-center gap-1.5 px-2 py-1 rounded-md border border-slate-200 bg-white">
          <button type="button"
                  class="w-7 h-7 flex items-center justify-center rounded text-slate-600 hover:bg-slate-100 transition-colors font-semibold text-lg"
                  data-action="click->transpose#transposeDown"
                  title="Transpose down one semitone">
            âˆ’
          </button>
          <div class="flex flex-col items-center min-w-[3rem]">
            <span class="text-xs text-slate-500 leading-tight">Key</span>
            <span class="text-sm font-semibold text-slate-900" data-transpose-target="keyDisplay">-</span>
          </div>
          <button type="button"
                  class="w-7 h-7 flex items-center justify-center rounded text-slate-600 hover:bg-slate-100 transition-colors font-semibold text-lg"
                  data-action="click->transpose#transposeUp"
                  title="Transpose up one semitone">
            +
          </button>
          <button type="button"
                  class="ml-1 px-2 py-1 text-xs text-slate-500 hover:text-slate-700 hover:bg-slate-100 rounded transition-colors"
                  data-action="click->transpose#reset"
                  title="Reset to original key">
            Reset
          </button>
        </div>
        <%# Singer Mode Toggle Button - only for chord tabs %>
        <button type="button"
                class="px-3 py-1.5 text-sm font-medium rounded-md border transition-colors bg-white text-slate-600 border-slate-200 hover:bg-slate-100"
                data-singer-mode-target="toggleButton"
                data-action="click->singer-mode#toggle"
                title="Singer Mode - Hide chords & tabs">
          <span class="flex items-center gap-1.5">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
            </svg>
            <span class="hidden sm:inline">Singer</span>
          </span>
        </button>
        <% elsif @tab.tab_type == "chords" %>
        <%# Singer Mode Toggle Button - only for chord tabs %>
        <button type="button"
                class="px-3 py-1.5 text-sm font-medium rounded-md border transition-colors bg-white text-slate-600 border-slate-200 hover:bg-slate-100"
                data-singer-mode-target="toggleButton"
                data-action="click->singer-mode#toggle"
                title="Singer Mode - Hide chords & tabs">
          <span class="flex items-center gap-1.5">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
            </svg>
            <span class="hidden sm:inline">Singer</span>
          </span>
        </button>
        <% end %>
        <div class="hidden sm:block shrink-0 text-sm text-slate-500">
          <%= @tab.created_at.to_date %>
        </div>
      </div>
    </div>
  </div>

  <% if has_chords && unique_chords.any? %>
  <%# Chord Dictionary - shown above tab content on mobile, sidebar on desktop %>
  <div class="mb-4 px-4 sm:px-0 lg:hidden">
    <div class="rounded-lg border border-slate-200 bg-white">
      <%# Header with collapse toggle - starts expanded on mobile %>
      <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200 cursor-pointer hover:bg-slate-50 transition-colors"
           data-action="click->chord-diagram#toggleMobileDictionary"
           data-chord-diagram-target="mobileDictionaryHeader">
        <h2 class="font-semibold text-slate-900">Chords</h2>
        <svg class="w-5 h-5 text-slate-400 transition-transform" 
             data-chord-diagram-target="mobileDictionaryArrow"
             style="transform: rotate(90deg);"
             fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
      </div>
      
      <%# Instrument selector %>
      <div class="px-4 py-2 border-b border-slate-100" data-chord-diagram-target="mobileDictionaryContent">
        <div class="flex items-center gap-1.5 flex-wrap" data-chord-diagram-target="instrumentSelector">
          <button type="button" 
                  class="px-2 py-1 text-xs font-medium rounded border border-slate-200 bg-slate-900 text-white transition-colors"
                  data-instrument="guitar"
                  data-action="click->chord-diagram#selectInstrument">
            Guitar
          </button>
          <button type="button" 
                  class="px-2 py-1 text-xs font-medium rounded border border-slate-200 bg-white text-slate-600 hover:bg-slate-100 transition-colors"
                  data-instrument="ukulele"
                  data-action="click->chord-diagram#selectInstrument">
            Ukulele
          </button>
          <button type="button" 
                  class="px-2 py-1 text-xs font-medium rounded border border-slate-200 bg-white text-slate-600 hover:bg-slate-100 transition-colors"
                  data-instrument="cavaquinho"
                  data-action="click->chord-diagram#selectInstrument">
            Cavaquinho
          </button>
          <button type="button" 
                  class="px-2 py-1 text-xs font-medium rounded border border-slate-200 bg-white text-slate-600 hover:bg-slate-100 transition-colors"
                  data-instrument="piano"
                  data-action="click->chord-diagram#selectInstrument">
            Piano
          </button>
        </div>
      </div>
      
      <%# Chord diagrams - horizontal scroll on mobile %>
      <div class="p-3 overflow-x-auto" data-chord-diagram-target="mobileDictionaryContent">
        <div class="flex gap-3 pb-2" data-chord-diagram-target="dictionaryGrid">
          <% unique_chords.each do |chord| %>
            <div class="flex-shrink-0 flex justify-center items-start"
                 data-chord="<%= chord %>"
                 data-chord-diagram-target="dictionaryChord">
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
  <% end %>

  <%# Main content area with optional chord dictionary sidebar on desktop %>
  <div class="flex flex-col lg:flex-row lg:gap-6">
    <%# Tab content (main area) %>
    <div class="flex-1 min-w-0 px-4 sm:px-0">
      <%# No border/padding on mobile, add them back on sm: screens %>
      <div class="sm:rounded-lg sm:border sm:border-slate-200 bg-white sm:p-4" data-controller="tab-wrapper">
        <div data-tab-wrapper-target="content">
          <%= render_ug_content(@tab.content) %>
        </div>
      </div>
    </div>

    <% if has_chords && unique_chords.any? %>
    <%# Chord Dictionary Sidebar - only visible on desktop (lg+) %>
    <div class="hidden lg:block lg:w-80 xl:w-96 shrink-0">
      <div class="rounded-lg border border-slate-200 bg-white sticky top-4">
        <%# Header with collapse toggle %>
        <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200 cursor-pointer hover:bg-slate-50 transition-colors"
             data-action="click->chord-diagram#toggleDictionary"
             data-chord-diagram-target="dictionaryHeader">
          <h2 class="font-semibold text-slate-900">Chords</h2>
          <svg class="w-5 h-5 text-slate-400 transition-transform" 
               data-chord-diagram-target="dictionaryArrow"
               style="transform: rotate(90deg);"
               fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </div>
        
        <%# Instrument selector %>
        <div class="px-4 py-2 border-b border-slate-100" data-chord-diagram-target="dictionaryContent">
          <div class="flex items-center gap-1.5 flex-wrap" data-chord-diagram-target="instrumentSelector">
            <button type="button" 
                    class="px-2 py-1 text-xs font-medium rounded border border-slate-200 bg-slate-900 text-white transition-colors"
                    data-instrument="guitar"
                    data-action="click->chord-diagram#selectInstrument">
              Guitar
            </button>
            <button type="button" 
                    class="px-2 py-1 text-xs font-medium rounded border border-slate-200 bg-white text-slate-600 hover:bg-slate-100 transition-colors"
                    data-instrument="ukulele"
                    data-action="click->chord-diagram#selectInstrument">
              Ukulele
            </button>
            <button type="button" 
                    class="px-2 py-1 text-xs font-medium rounded border border-slate-200 bg-white text-slate-600 hover:bg-slate-100 transition-colors"
                    data-instrument="cavaquinho"
                    data-action="click->chord-diagram#selectInstrument">
              Cavaquinho
            </button>
            <button type="button" 
                    class="px-2 py-1 text-xs font-medium rounded border border-slate-200 bg-white text-slate-600 hover:bg-slate-100 transition-colors"
                    data-instrument="piano"
                    data-action="click->chord-diagram#selectInstrument">
              Piano
            </button>
          </div>
        </div>
        
        <%# Chord diagrams - 2 column grid %>
        <div class="p-3 max-h-[70vh] overflow-y-auto" data-chord-diagram-target="dictionaryContent">
          <div class="grid grid-cols-2 gap-2" data-chord-diagram-target="dictionaryGrid">
            <% unique_chords.each do |chord| %>
              <div class="flex justify-center items-start p-1"
                   data-chord="<%= chord %>"
                   data-chord-diagram-target="dictionaryChord">
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
    <% end %>
  </div>

  <% if has_chords %>
  <%# Tooltip for desktop hover %>
  <div class="hidden fixed z-50 bg-white rounded-xl shadow-2xl border border-slate-200 p-3 pointer-events-auto"
       data-chord-diagram-target="tooltip"
       style="min-width: 140px;">
  </div>

  <%# Mobile bottom panel for tapping on chords in the tab %>
  <div class="hidden fixed inset-0 z-50 bg-black/50 flex-col justify-end md:hidden"
       data-chord-diagram-target="mobilePanel"
       data-action="click->chord-diagram#closeMobilePanel">
    <div class="bg-white rounded-t-2xl shadow-2xl max-h-[70vh] overflow-hidden"
         data-action="click->chord-diagram#stopPropagation">
      <%# Mobile panel header with close button and instrument selector %>
      <div class="flex items-center justify-between p-4 border-b border-slate-200">
        <div class="flex items-center gap-2">
          <button type="button" 
                  class="px-2.5 py-1 text-xs font-medium rounded-md border border-slate-200 bg-slate-900 text-white"
                  data-instrument="guitar"
                  data-action="click->chord-diagram#selectInstrument">
            ðŸŽ¸
          </button>
          <button type="button" 
                  class="px-2.5 py-1 text-xs font-medium rounded-md border border-slate-200 bg-white text-slate-600"
                  data-instrument="ukulele"
                  data-action="click->chord-diagram#selectInstrument">
            ðŸª•
          </button>
          <button type="button" 
                  class="px-2.5 py-1 text-xs font-medium rounded-md border border-slate-200 bg-white text-slate-600"
                  data-instrument="cavaquinho"
                  data-action="click->chord-diagram#selectInstrument"
                  title="Cavaquinho">
            ðŸŽ»
          </button>
          <button type="button" 
                  class="px-2.5 py-1 text-xs font-medium rounded-md border border-slate-200 bg-white text-slate-600"
                  data-instrument="piano"
                  data-action="click->chord-diagram#selectInstrument">
            ðŸŽ¹
          </button>
        </div>
        <button type="button" 
                class="p-2 text-slate-400 hover:text-slate-600"
                data-action="click->chord-diagram#closeMobilePanel">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <%# Chord diagram content %>
      <div class="p-6 flex items-center justify-center" data-chord-content>
      </div>
    </div>
  </div>
  <% end %>
</div>
